name: Release Build

on:
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

permissions:
  contents: write

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            artifact_name: wing-linux
            asset_name: wing-linux.tar.gz
          - os: windows-latest  
            artifact_name: wing-windows
            asset_name: wing-windows.zip
            
    runs-on: ${{ matrix.os }}

    steps:
    - uses: actions/checkout@v4
    - uses: actions-rust-lang/setup-rust-toolchain@v1

    - name: Build all targets
      run: |
        cargo build --release --all-targets

    - name: Package Linux Build
      if: matrix.os == 'ubuntu-latest'
      run: |
        mkdir -p ${{ matrix.artifact_name }}
        cp target/release/liblibwing.so ${{ matrix.artifact_name }}/
        cp target/release/examples/wingmon ${{ matrix.artifact_name }}/
        cp target/release/examples/wingschema ${{ matrix.artifact_name }}/
        cp target/release/examples/wingprop ${{ matrix.artifact_name }}/
        cp target/release/examples/wingmeters ${{ matrix.artifact_name }}/
        tar czf ${{ matrix.asset_name }} ${{ matrix.artifact_name }}

    - name: Package Windows Build  
      if: matrix.os == 'windows-latest'
      run: |
        mkdir ${{ matrix.artifact_name }}
        copy target\release\libwing.dll ${{ matrix.artifact_name }}\
        copy target\release\examples/wingmon.exe ${{ matrix.artifact_name }}\
        copy target\release\examples/wingschema.exe ${{ matrix.artifact_name }}\
        copy target\release\examples/wingprop.exe ${{ matrix.artifact_name }}\
        copy target\release\examples/wingmeters.exe ${{ matrix.artifact_name }}\
        7z a ${{ matrix.asset_name }} ${{ matrix.artifact_name }}

    - name: Create Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/heads/release')
      with:
        files: ${{ matrix.asset_name }}
        tag_name: v${{ github.run_number }}
        generate_release_notes: true
